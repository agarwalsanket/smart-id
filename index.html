<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Smart ID</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="main.css">
        <script src="./node_modules/web3/dist/web3.min.js"></script>
      </head>
<body>

<div class="container">
        <h3 class="text-center">Enter your information: </h3>  

  <div class="jumbotron">
	  <!--<h2 id="confirmation"></h2>-->
	  <div class="modal fade" id="mySmartInfoModal" role="dialog">
			<div class="modal-dialog">
			
			  <!-- Modal content-->
			  <div class="modal-content">
				<div class="modal-header">
				  <button type="button" class="close" data-dismiss="modal">&times;</button>
				  <h4 class="modal-title">Saved Profile</h4>
				</div>
				<div class="modal-body">
				<ul class="list-group">
					<li class="list-group-item">Address: <span id="addrMod" ></span></li>
					<li class="list-group-item">Name: <span id="nameMod" ></span></li> 
					<li class="list-group-item">DOB: <span id="dobMod"></span></li> 
					<li class="list-group-item">Age: <span id="ageMod"></span></li>
					<li class="list-group-item">Gender: <span id="genMod"></span></li> 
					<li class="list-group-item">Mobile: <span id="mobMod"></span></li> 
					<li class="list-group-item">Mailing: <span id="mailMod"></span></li>
					<li class="list-group-item">Permanent Address: <span id="permMod"></span></li> 
					<li class="list-group-item">Email: <span id="emailMod"></span></li> 
					<li class="list-group-item">Unique ID: <span id="UniqueIdMod"></span></li> 
					<!--<li class="list-group-item">Unique ID: <span id="idMod"></span></li> -->
					
				</ul>
				</div>
				<div class="modal-footer">
				  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			  </div>
			  
			</div>
		  </div>
	  <span id="smartTransHash"></span>
      <img id="loader" src = "https://loading.io/spinners/double-ring/lg.double-ring-spineer.gif">
      
      <div class="form-horizontal">

	<!--<div class="form-group">
			<label class="control-label col-sm-2" for="PuAddr">Public Address</label>
			<div class="col-sm-10">
				<input type="text" class="form-control" id="PuAddr" placeholder="Enter your public address" name="PuAddr">
			</div>
		</div>-->

        <div class="form-group">
            <label class="control-label col-sm-2" for="name">Name</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="name" placeholder="Enter name" name="name">
            </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-2" for="email">Email</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="email" placeholder="Enter email" name="email">
          </div>
        </div>

        <div class="form-group">
            <label class="control-label col-sm-2" for="age">Age</label>
            <div class="col-sm-10">
              <input type="number" class="form-control" id="age" placeholder="Enter age" name="age">
            </div>
        </div>
        
        <div class="form-group">
            <label class="control-label col-sm-2" for="dob">DOB</label>
            <div class="col-sm-10">
              <input type="date" class="form-control" id="dob" placeholder="Enter date of birth" name="dob">
            </div>
        </div>
        
        <div class="form-group">
            <label class="control-label col-sm-2" for="mob">Mobile</label>
            <div class="col-sm-10">
              <input type="number" class="form-control" id="mob" placeholder="Enter Mobile number" name="mob">
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-sm-2" for="ipaddr">Mailing Address</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="ipaddr" placeholder="Apartment, area, zip" name="ipaddr">
          </div>
        </div>
        
        <div class="form-group">
            <label class="control-label col-sm-2" for="praddr">Permanent Address</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="praddr" placeholder="Apartment, area, zip" name="praddr">
          </div>
        </div>

        <div class="form-group">
            <label class="control-label col-sm-2" for="Uid">GUID</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="Uid" placeholder="Enter your unique ID" name="Uid">
          </div>
        </div>

        <div class="form-group">
          <label class="control-label col-sm-2" for="gender">Gender</label>
          
          <label class="radio-inline">
             <input type="radio" name="gender" value="Male" id="gen"> M
          </label>
          <label class="radio-inline">
             <input type="radio" name="gender" value="Female" id="gen"> F
          </label>
      </div>

        
        <!--<div class="form-group">        
          <div class="col-sm-offset-2 col-sm-10">
            <button id="setProfileBtn" type="submit" class="btn btn-default">Submit information</button>
		  </div>-->
		  
		  <div class="btn-group btn-group-justified">
			<div class="btn-group">
			  <button id="setProfileBtn" type="button" class="btn btn-primary">Save Profile</button>
			</div>
			<div class="btn-group">
			  <!--<button id="getProfileBtn" type="button" class="btn btn-primary">View information</button>-->
			  <button id="getProfileBtn" type="button" class="btn btn-info " data-toggle="modal" data-target="#mySmartInfoModal">View Profile</button>
			</div>
			<div class="btn-group">
			  <button id="sendInfo" type="button" class="btn btn-primary">Send Profile</button>
			</div>
		  </div>
        </div>
      
      </div>
 
  </div>
  
</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>



<!-- Contract scripting starts here -->

<script>
  if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
  } else {
      web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }

  web3.eth.defaultAccount = web3.eth.accounts[0];

  var smartIDContract = web3.eth.contract([
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "profile_owner_Address",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "fullName",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "dob",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "age",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "gender",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "mobileNo",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "mailingAddress",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "permanentAddress",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "emailId",
				"type": "bytes32"
			}
		],
		"name": "ProfileGetting",
		"type": "event"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_to",
				"type": "address"
			},
			{
				"name": "_send",
				"type": "bool[]"
			}
		],
		"name": "sendProfile",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "profile_owner_Address",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "fullName",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "dob",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "age",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "gender",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "mobileNo",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "mailingAddress",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "permanentAddress",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "emailId",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"name": "Uid",
				"type": "bytes32"
			}
		],
		"name": "ProfileSetting",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "notificationMsg",
				"type": "bytes32"
			}
		],
		"name": "ChangeNotification",
		"type": "event"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_name",
				"type": "bytes32"
			},
			{
				"name": "_dob",
				"type": "bytes32"
			},
			{
				"name": "_age",
				"type": "bytes32"
			},
			{
				"name": "_gender",
				"type": "bytes32"
			},
			{
				"name": "_mobile",
				"type": "bytes32"
			},
			{
				"name": "_mailing",
				"type": "bytes32"
			},
			{
				"name": "_permanent",
				"type": "bytes32"
			},
			{
				"name": "_email",
				"type": "bytes32"
			},
			{
				"name": "_Uid",
				"type": "bytes32"
			}
		],
		"name": "setProfile",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getProfile",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"name": "lastProfileIndex",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"name": "profiles",
		"outputs": [
			{
				"name": "profile_owner_Address",
				"type": "address"
			},
			{
				"name": "fullName",
				"type": "bytes32"
			},
			{
				"name": "dob",
				"type": "bytes32"
			},
			{
				"name": "age",
				"type": "bytes32"
			},
			{
				"name": "gender",
				"type": "bytes32"
			},
			{
				"name": "mobileNo",
				"type": "bytes32"
			},
			{
				"name": "mailingAddress",
				"type": "bytes32"
			},
			{
				"name": "permanentAddress",
				"type": "bytes32"
			},
			{
				"name": "emailId",
				"type": "bytes32"
			},
			{
				"name": "Uid",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "readReceivedProfile1",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "readReceivedProfile2",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			},
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "receivedProfile",
		"outputs": [
			{
				"name": "profile_owner_Address",
				"type": "address"
			},
			{
				"name": "fullName",
				"type": "bytes32"
			},
			{
				"name": "dob",
				"type": "bytes32"
			},
			{
				"name": "age",
				"type": "bytes32"
			},
			{
				"name": "gender",
				"type": "bytes32"
			},
			{
				"name": "mobileNo",
				"type": "bytes32"
			},
			{
				"name": "mailingAddress",
				"type": "bytes32"
			},
			{
				"name": "permanentAddress",
				"type": "bytes32"
			},
			{
				"name": "emailId",
				"type": "bytes32"
			},
			{
				"name": "Uid",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]);

  var smartID = smartIDContract.at('0xe6763ca39022baf3c1a06b1ba350f26bebdb5328');
  //console.log(smartID);

var settingProfileEvent  = smartID.ProfileSetting({}, 'latest'); //Event for setting profile

var gettingProfileEvent  = smartID.ProfileGetting({}, 'latest'); //Event for getting profile

//Watching the setting event
settingProfileEvent.watch(function(error, result){
    if(!error){
		//console.log("Inside event");
       if (result.blockHash != $("#smartTransHash").html())
               $("#loader").hide();
       $("#smartTransHash").html('Block hash: ' + result.blockHash);
       //$("#name").html(web3.toAscii(result.args.fullName) + ' ' + web3.toAscii(result.args.dob) + '  ' + result.args.mobileNo);
    }
    else{
       $('#loader').hide();
       console.log(error);
	   //console.log("Inside event but error");
    }

});

//Watching the getting event
gettingProfileEvent.watch(function(error, result){
	console.log("Atleast inside event");
    if(!error){
		console.log("Inside Getting event");
       $("#loader").hide();
       $("#addr").html(web3.toAscii(result.args.fullName));
    }
    else{
       $('#loader').hide();
       console.log(error);
	   //console.log("Inside event but error");
    }

});

// Getting the profile information
$("#getProfileBtn").click(function() {
    console.log("hello from button getter");

		// Encrypting Function call over here and return values will be passed to setProfile
	 smartID.getProfile((err, result) => {
          if(err){
            console.log(error);
           $('#loader').hide();
          }
		  else{
			$("#addrMod").html(result[0]);
			$("#nameMod").html(web3.toAscii(result[1]));
			$("#dobMod").html(web3.toAscii(result[2]));
			$("#ageMod").html(web3.toAscii(result[3]));
			$("#genMod").html(web3.toAscii(result[4]));
			$("#mobMod").html(web3.toAscii(result[5]));
			$("#mailMod").html(web3.toAscii(result[6]));
			$("#permMod").html(web3.toAscii(result[7]));
			$("#emailMod").html(web3.toAscii(result[8]));
			$("#UniqueIdMod").html(web3.toAscii(result[9]));
			
			console.log(web3.toAscii(result[9]));
		  }
      });

	//$('#loader').show();
  });


  $("#setProfileBtn").click(function() {
    console.log($("#Uid").val());
	console.log($("#PuAddr").val());
	console.log("hello from button setter");

		// Encrypting Function call over here and return values will be passed to setProfile
	 smartID.setProfile($("#name").val(), $("#dob").val(), $("#age").val(),$('input[name=gender]:checked').val(), $("#mob").val(), $("#ipaddr").val(),$("#praddr").val(), $("#email").val(),$("#Uid").val(), (err, res) => {
          if(err){
            console.log(error);
           $('#loader').hide();
          }
      });
    //smartID.setProfile($("#name").val(), $("#dob").val(), $("#age").val(),$("#gen").val(), $("#mob").val(), $("#ipaddr").val(),$("#praddr").val(), $("#email").val());
    /*smartID.setProfile1($("#name").val(), $("#dob").val(),(err, res) => {
		if(err){
            console.log(error);
           $('#loader').hide();
          }
	});
    smartID.setProfile2($("#age").val(),$("#gen").val(), $("#mob").val(),(err, res) =>{
		if(err){	
            console.log(error);
           $('#loader').hide();
          }
	});
    smartID.setProfile3($("#ipaddr").val(),$("#praddr").val(), $("#email").val(),(err, res) =>{
		if(err){
            console.log(error);
           $('#loader').hide();
          }
	});*/
	$('#loader').show();
  });
  function bin2string(array){
	var result = "";
	for(var i = 0; i < array.length; ++i){
		result+= (String.fromCharCode(array[i]));
	}
	return result;
}
</script>

</body>
</html>
